# tether/.github/workflows/ci-cd.yml
name: CI/CD Pipeline

# Trigger rules including label-based triggers
on:
  pull_request:
    types: [labeled, unlabeled, opened, synchronize, reopened]
  push:
    branches: [main]
  workflow_dispatch: # Optional, for manual trigger

# All jobs declared below will run
jobs:
  # ---------- 1. Basic PR verification (runs on every PR) ----------
  pr-verification:
    if: github.event_name == 'pull_request'
    # Uses reusable workflow from devops-automation repo
    uses: maksim-sialitski-innowise/devops-automation/.github/workflows/pr-verification.yml@main
    with:
      node-version: '20'

  # ---------- 2. Integration tests (only with 'verify' label) ----------
  integration-tests:
    if: |
      github.event_name == 'pull_request' &&
      contains(github.event.pull_request.labels.*.name, 'verify')
    needs: pr-verification # Wait for basic checks to complete
    uses: maksim-sialitski-innowise/devops-automation/.github/workflows/verify-label.yml@main
    with:
      node-version: '20'

  # ---------- 3. Create Release Candidate (only with 'publish' label) ----------
  release-candidate:
    if: |
      github.event_name == 'pull_request' &&
      contains(github.event.pull_request.labels.*.name, 'publish')
    needs: [pr-verification, integration-tests] # Wait for previous steps
    uses: maksim-sialitski-innowise/devops-automation/.github/workflows/publish-label.yml@main
    secrets:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }} # Pass token for NPM version check

  # ---------- 4. Final publication (after merge to main) ----------
  publish:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org/'

      - name: Install GitHub CLI
        run: |
          type -p curl >/dev/null || sudo apt update && sudo apt install curl -y
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y

      - name: Get package version
        id: get-version
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Verify version is not published
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          VERSION="${{ steps.get-version.outputs.version }}"
          echo "Checking if version $VERSION of $PACKAGE_NAME exists on npm..."
          
          # If version already exists, pipeline will fail
          if npm view $PACKAGE_NAME@$VERSION version > /dev/null 2>&1; then
            echo "ERROR: Version $VERSION of $PACKAGE_NAME already exists on npm!"
            exit 1
          fi
          echo "Version $VERSION is available for publishing"

      - name: Install dependencies
        run: npm ci

      - name: Run build and test (final verification)
        run: |
          npm run build
          npm test

      # === Publish to npm ===
      - name: Publish to npm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "Publishing to npm..."
          npm publish --access public
          echo "Successfully published to npm!"

      # === Create tag and release ===
      - name: Create Git tag and GitHub Release
        env:
          GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          echo "Creating release v$VERSION..."
          
          # Configure git
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          
          # Create and push tag
          git tag -a "v$VERSION" -m "Release v$VERSION"
          git push origin "v$VERSION"
          
          # Create GitHub release
          gh release create "v$VERSION" \
            --title "v$VERSION" \
            --notes "Automated release" \
            --target main
          
          echo "Release v$VERSION created successfully!"
