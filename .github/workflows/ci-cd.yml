# tether/.github/workflows/ci-cd.yml
name: CI/CD Pipeline

on:
  pull_request:
    types: [labeled, unlabeled, opened, synchronize, reopened, closed]
  push:
    branches: [main]
  workflow_dispatch: # Optional, for manual trigger

jobs:
  # ---------- 1. Basic PR verification (runs on every PR) ----------
  pr-verification:
    if: github.event_name == 'pull_request'
    uses: maksim-sialitski-innowise/devops-automation/.github/workflows/pr-verification.yml@main
    with:
      node-version: '20'

  # ---------- 2. Integration tests (only with 'verify' label) ----------
  integration-tests:
    if: |
      github.event_name == 'pull_request' &&
      contains(github.event.pull_request.labels.*.name, 'verify')
    needs: pr-verification # Wait for basic checks to complete
    uses: maksim-sialitski-innowise/devops-automation/.github/workflows/verify-label.yml@main
    with:
      node-version: '20'

  # ---------- 3. Create Release Candidate (only with 'publish' label) ----------
  release-candidate:
    if: |
      github.event_name == 'pull_request' &&
      contains(github.event.pull_request.labels.*.name, 'publish')
    needs: [pr-verification, integration-tests] # Wait for previous steps
    uses: maksim-sialitski-innowise/devops-automation/.github/workflows/publish-label.yml@main
    with:
      node-version: '20'
      add-dev-suffix: true
    secrets:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }} # Pass token for NPM version check

  # ---------- 4. Release on Merge (when PR with 'publish' label is merged) ----------
  publish:
    if: |
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main' &&
      github.event.head_commit.message =~ /^Merge pull request #\d+/
    uses: maksim-sialitski-innowise/devops-automation/.github/workflows/main-publish.yml@main
    with:
      node-version: '20'
      target-version: ${{ needs.release-candidate.outputs.package-version }}
    secrets:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
